<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina - AI Image Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #6c5ce7;
            --accent-glow: #a29bfe;
            --text-main: #ffffff;
            --text-muted: #b2bec3;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Hide main scrollbar */
            display: flex;
        }

        /* --- SIDEBAR (CONTROLS) --- */
        .sidebar {
            width: 360px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(to right, #a29bfe, #74b9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }

        /* --- PANELS --- */
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            transition: transform 0.2s;
        }
        .panel:hover {
            border-color: rgba(255,255,255,0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .panel h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            display: flex; align-items: center; gap: 8px;
        }

        /* --- SLIDERS (Modern CSS) --- */
        .control-group { margin-bottom: 15px; }
        .label-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: var(--text-muted); }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* --- SELECTS --- */
        select {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 8px;
            outline: none;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
        }
        select:hover { border-color: var(--accent); }

        /* --- BUTTONS --- */
        .btn-main {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }

        .btn-upload {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6); }

        .btn-reset {
            background: transparent;
            border: 1px solid rgba(255, 94, 87, 0.5);
            color: #ff7675;
            font-size: 12px;
            padding: 8px;
        }
        .btn-reset:hover { background: rgba(255, 94, 87, 0.1); }
        
        /* Hidden file input trick */
        #fileInput { display: none; }
        
        /* --- MAIN PREVIEW AREA --- */
        .main-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .canvas-container {
            position: relative;
            max-width: 90%;
            max-height: 85vh;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            background: repeating-conic-gradient(#1e1e1e 0% 25%, #252525 0% 50%) 50% / 20px 20px; /* Checkerboard pattern for transparency */
        }

        img {
            display: block;
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            border: 2px dashed var(--glass-border);
            padding: 50px;
            border-radius: 20px;
        }
        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }

        /* --- STATUS BAR --- */
        .status-badge {
            position: absolute;
            top: 20px; right: 40px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex; align-items: center; gap: 8px;
            border: 1px solid var(--glass-border);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .dot.active { background: #00b894; box-shadow: 0 0 10px #00b894; }

        /* --- HISTOGRAM --- */
        .hist-wrapper {
            height: 100px;
            width: 100%;
            position: relative;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <i class="ph ph-aperture"></i> LUMINA
        </div>

        <button onclick="resetAll()" class="btn-main btn-reset">
            <i class="ph ph-arrow-counter-clockwise"></i> Reset All Settings
        </button>

        <div class="panel">
            <h3><i class="ph ph-folder-open"></i> File</h3>
            <button onclick="document.getElementById('fileInput').click()" class="btn-main btn-upload" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
                Select Image
            </button>
            <input type="file" id="fileInput" accept="image/*" onchange="uploadImage()">
            
            <button onclick="downloadImage()" class="btn-main btn-upload">
                <i class="ph ph-download-simple"></i> Save & Download
            </button>
        </div>

        <div class="panel">
            <h3><i class="ph ph-chart-bar"></i> Histogram</h3>
            <div class="hist-wrapper">
                <canvas id="histChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3><i class="ph ph-sun"></i> Light & Color</h3>
            
            <div class="control-group">
                <div class="label-row"><span>Brightness</span><span id="val_brightness">0</span></div>
                <input type="range" id="brightness" min="-100" max="100" value="0" oninput="updateUI(this); sendData()">
            </div>

            <div class="control-group">
                <div class="label-row"><span>Contrast</span><span id="val_contrast">1.0</span></div>
                <input type="range" id="contrast" min="0.0" max="3.0" step="0.1" value="1.0" oninput="updateUI(this); sendData()">
            </div>

            <div class="control-group">
                <div class="label-row"><span>Gamma</span><span id="val_gamma">1.0</span></div>
                <input type="range" id="gamma" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateUI(this); sendData()">
            </div>

            <div class="control-group">
                <div class="label-row"><span>Shadows</span><span id="val_shadows">0</span></div>
                <input type="range" id="shadows" min="0" max="100" value="0" oninput="updateUI(this); sendData()">
            </div>

            <div class="control-group">
                <div class="label-row"><span>Highlights</span><span id="val_highlights">0</span></div>
                <input type="range" id="highlights" min="0" max="100" value="0" oninput="updateUI(this); sendData()">
            </div>
        </div>

        <div class="panel">
            <h3><i class="ph ph-magic-wand"></i> Filters</h3>
            <select id="filter" onchange="sendData()">
                <option value="none">Normal</option>
                <option value="levels">Auto Levels (Safe)</option>
                <option value="clahe">Auto Contrast (Strong)</option>
                <option value="blur">Gaussian Blur</option>
                <option value="sharpen">Sharpening</option>
                <option value="canny">Canny Edge</option>
            </select>
        </div>

        <div class="panel">
            <h3><i class="ph ph-crop"></i> Geometry</h3>
            
            <div class="control-group">
                <div class="label-row"><span>Scale</span><span id="val_scale">100%</span></div>
                <input type="range" id="scale" min="10" max="200" value="100" oninput="updateUI(this); sendData()">
            </div>
<div class="control-group">
    <div class="label-row"><span>Interpolation</span></div>
    <select id="interpolation" onchange="sendData()">
        <option value="linear">Linear (Smooth)</option>
        <option value="nearest">Nearest (Pixel Art)</option>
        <option value="cubic">Cubic (High Quality)</option>
    </select>
</div>
            <div class="control-group" style="display:flex; gap:10px;">
                <select id="rotation" onchange="sendData()">
                    <option value="0">Rotation: 0째</option>
                    <option value="90">90째 CW</option>
                    <option value="180">180째</option>
                    <option value="270">90째 CCW</option>
                </select>
                <select id="flip" onchange="sendData()">
                    <option value="none">Flip: None</option>
                    <option value="horizontal">Horiz</option>
                    <option value="vertical">Vert</option>
                </select>
            </div>
        </div>
        
        <div class="panel">
            <h3><i class="ph ph-selection-foreground"></i> Analysis</h3>
            <select id="threshold" onchange="sendData()" style="margin-bottom: 10px;">
                <option value="none">Threshold: None</option>
                <option value="binary">Binary</option>
                <option value="otsu">Otsu (Auto)</option>
                <option value="adaptive">Adaptive</option>
            </select>
            
            <select id="morph" onchange="sendData()" style="margin-bottom: 10px;">
                <option value="none">Morph: None</option>
                <option value="erosion">Erosion</option>
                <option value="dilation">Dilation</option>
                <option value="opening">Opening</option>
                <option value="closing">Closing</option>
                <option value="gradient">Gradient</option>
            </select>
            
            <div class="control-group">
                <div class="label-row"><span>Kernel Size</span><span id="val_morph_size">3</span></div>
                <input type="range" id="morph_size" min="3" max="15" step="2" value="3" oninput="updateUI(this); sendData()">
            </div>
        </div>

    </div>

    <div class="main-content">
        <div class="status-badge">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">Ready</span>
        </div>

        <div id="preview-box" class="canvas-container" style="display: none;">
            <img id="live-image" src="">
        </div>

        <div id="empty-state" class="empty-state">
            <i class="ph ph-image"></i>
            <h2>No Image Loaded</h2>
            <p>Upload an image from the sidebar to start editing.</p>
        </div>
    </div>

    <script>
        // --- UI HELPERS ---
        function updateUI(input) {
            // Updates the number next to the slider
            const label = document.getElementById('val_' + input.id);
            if(label) label.innerText = input.value;
        }

        // --- CHART SETUP ---
        let histChart = null;
        if(document.getElementById('histChart')) {
            const ctx = document.getElementById('histChart').getContext('2d');
            
            // Modern Gradient for Chart
            let gradientR = ctx.createLinearGradient(0, 0, 0, 100);
            gradientR.addColorStop(0, 'rgba(255, 118, 117, 0.5)');
            gradientR.addColorStop(1, 'rgba(255, 118, 117, 0)');

            histChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 256}, (_, i) => i),
                    datasets: [
                        { label: 'R', data: [], borderColor: '#ff7675', borderWidth: 1, pointRadius: 0, fill: true, backgroundColor: gradientR },
                        { label: 'G', data: [], borderColor: '#55efc4', borderWidth: 1, pointRadius: 0 },
                        { label: 'B', data: [], borderColor: '#74b9ff', borderWidth: 1, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: { x: {display: false}, y: {display: false} },
                    plugins: { legend: {display: false} }
                }
            });
        }

        // --- UPLOAD ---
        function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            
            setStatus('Uploading...', 'active');

            fetch('/upload_ajax', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'success') {
                    document.getElementById('empty-state').style.display = 'none';
                    document.getElementById('preview-box').style.display = 'block';
                    resetAll();
                } else {
                    alert('Upload Failed');
                }
            });
        }

        // --- DOWNLOAD ---
        function downloadImage() {
            const data = getControlData();
            fetch('/download_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Lumina_Result.jpg";
                document.body.appendChild(a);
                a.click();
                a.remove();
            });
        }

        function getControlData() {
            return {
                scale: document.getElementById('scale').value,
                interpolation: document.getElementById('interpolation').value, 
                rotation: document.getElementById('rotation').value,
                flip: document.getElementById('flip').value,
                brightness: document.getElementById('brightness').value,
                contrast: document.getElementById('contrast').value,
                gamma: document.getElementById('gamma').value,
                shadows: document.getElementById('shadows').value,
                highlights: document.getElementById('highlights').value,
                threshold: document.getElementById('threshold').value,
                morph: document.getElementById('morph').value,
                morph_size: document.getElementById('morph_size').value,
                filter: document.getElementById('filter').value
            };
        }

        function resetAll() {
            // Reset Inputs
            document.getElementById('scale').value = 100;
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 1.0;
            document.getElementById('gamma').value = 1.0;
            document.getElementById('shadows').value = 0;
            document.getElementById('highlights').value = 0;
            document.getElementById('morph_size').value = 3;
            
            // Reset Selects
            ['rotation', 'flip', 'filter', 'threshold', 'morph'].forEach(id => {
                document.getElementById(id).selectedIndex = 0;
            });
            
            // Update labels
            document.querySelectorAll('input[type="range"]').forEach(el => updateUI(el));

            sendData();
        }

        function setStatus(text, state) {
            document.getElementById('status-text').innerText = text;
            const dot = document.getElementById('status-dot');
            if(state === 'active') dot.classList.add('active');
            else dot.classList.remove('active');
        }

        let timeout = null;
        function sendData() {
            setStatus('Processing...', 'active');
            clearTimeout(timeout);
            
            timeout = setTimeout(() => {
                const data = getControlData();

                fetch('/process_live', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(r => r.json())
                .then(d => {
                    if(d.image) {
                        document.getElementById('live-image').src = 'data:image/jpeg;base64,' + d.image;
                        
                        if(d.histogram && histChart) {
                            histChart.data.datasets[0].data = d.histogram.r;
                            histChart.data.datasets[1].data = d.histogram.g;
                            histChart.data.datasets[2].data = d.histogram.b;
                            histChart.update();
                        }
                        setStatus('Live Preview', 'active');
                    }
                });
            }, 100);
        }
    </script>
</body>
</html>
